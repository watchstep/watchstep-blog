{{ define "main" }}

{{/* ===== Title / Subtitle from content/_index.md ===== */}}
{{ $pageTitle := or .Title .Site.Title }}
{{ $subtitle  := or .Params.lead (site.Params.home.subtitle | default "A minimal blog about AI & development.") }}

{{/* ===== Time window: last 6 months (26 weeks), Monday-aligned ===== */}}
{{ $now := now }}
{{ $weeks := 26 }}
{{ $oneDay := 86400 }}
{{ $rawStart := sub $now.Unix (mul (mul $weeks 7) $oneDay) }}
{{ $wdstr := dateFormat "Mon" (time $rawStart) }}
{{ $wdmap := dict "Mon" 0 "Tue" 1 "Wed" 2 "Thu" 3 "Fri" 4 "Sat" 5 "Sun" 6 }}
{{ $shift := index $wdmap $wdstr | default 0 }}
{{ $start := sub $rawStart (mul $shift $oneDay) }}

{{/* ===== Posts ===== */}}
{{ $allPosts  := where .Site.RegularPages "Section" "in" (slice "blog" "posts") }}
{{ $inWindow  := where $allPosts "Date.Unix" ">" $start }}
{{ $S := newScratch }}
{{ range $p := $inWindow }}
  {{ $k := $p.Date.Format "2006-01-02" }}
  {{ $prev := $S.Get (printf "d.%s" $k) | default 0 }}
  {{ $S.Set (printf "d.%s" $k) (add $prev 1) }}
{{ end }}

{{/* ===== Stats ===== */}}
{{ $totalPosts := len $allPosts }}
{{ $thisMonth := $now.Format "2006-01" }}
{{ $thisMonthCount := 0 }}
{{ range $p := $allPosts }}{{ if eq ($p.Date.Format "2006-01") $thisMonth }}{{ $thisMonthCount = add $thisMonthCount 1 }}{{ end }}{{ end }}

{{ $tagPairs := slice }}
{{ range $name, $tax := .Site.Taxonomies.tags }}
  {{ $p := where $tax.Pages "Section" "in" (slice "blog" "posts") }}
  {{ $cnt := len $p }}
  {{ if gt $cnt 0 }}{{ $tagPairs = $tagPairs | append (dict "tag" $name "count" $cnt) }}{{ end }}
{{ end }}
{{ $topTags := first 3 (sort $tagPairs "count" "desc") }}

{{ $since := "" }}
{{ with (first 1 (sort $allPosts "Date" "asc")) }}{{ $since = (index . 0).Date.Format "Jul 2, 2006" }}{{ end }}

{{/* ===== Grid metrics ===== */}}
{{ $cell := 14 }}  {{ $gap := 4 }}  {{ $step := add $cell $gap }}
{{ $left := 64 }}  {{ $top := 24 }}
{{ $svgW := add $left (mul $weeks $step) }}
{{ $svgH := add $top (mul 7 $step) }}

<section class="section container py-4">

  <!-- 페이지 전체 ‘새싹 스프링클’ 레이어 (외부 JS가 읽어감) -->
  <div
    id="ws-sprinkle"
    aria-hidden="true"
    data-seedling="{{ "images/seedling.png" | absURL }}">
  </div>

  <div class="ws-center">
    <h1 class="display-4 fw-bold text-center m-0">{{ $pageTitle }}</h1>
    {{ with $subtitle }}
      <p class="lead text-muted text-center mt-1 ws-subtitle">{{ . }}</p>
    {{ end }}

    <!-- Stats -->
    <div class="ws-stats ws-stats--top">
      <div class="ws-metric">
        <div class="ws-metric__label">Total posts</div>
        <div class="ws-metric__value">{{ $totalPosts }} <span class="ws-unit">posts</span></div>
        <div class="ws-metric__sub">since {{ if $since }}{{ $since }}{{ else }}—{{ end }}</div>
      </div>
      <div class="ws-metric">
        <div class="ws-metric__label">This month</div>
        <div class="ws-metric__value">{{ $thisMonthCount }} <span class="ws-unit">posts</span></div>
        <div class="ws-metric__sub">{{ $now.Format "Jan 2006" }}</div>
      </div>
      <div class="ws-metric">
        <div class="ws-metric__label">Top tags</div>
        <div class="ws-metric__value ws-tags-big">
          {{ if gt (len $topTags) 0 }}
            {{ range $i, $it := $topTags }}{{ if gt $i 0 }}<span class="ws-tag-sep">·</span>{{ end }}<span class="ws-tag">#{{ $it.tag }}</span>{{ end }}
          {{ else }}<span class="ws-tag">—</span>{{ end }}
        </div>
        <div class="ws-metric__sub">across all posts</div>
      </div>
    </div>

    <!-- Activity heatmap -->
    <div class="ws-lawn-wrap" style="--ws-left: {{ $left }}px;">
      <svg class="ws-lawn" width="{{ $svgW }}" height="{{ $svgH }}"
           role="img" aria-label="Posting activity for last 6 months">

        <!-- Months -->
        <g class="ws-months" font-size="11">
          {{ $lastM := "" }}
          {{ range $w := seq $weeks }}
            {{ $colU := add $start (mul (mul (sub $w 1) 7) $oneDay) }}
            {{ $dt := time $colU }}
            {{ $m := dateFormat "Jan" $dt }}
            {{ $d := int (dateFormat "2" $dt) }}
            {{ if and (ne $m $lastM) (le $d 7) }}
              <text x="{{ add $left (mul (sub $w 1) $step) }}" y="12" class="ws-month">{{ $m }}</text>
              {{ $lastM = $m }}
            {{ end }}
          {{ end }}
        </g>

        <!-- Weekdays (Sun on top; show labels at Mon(2)/Wed(4)/Fri(6)) -->
        <g class="ws-weekdays" text-anchor="end" font-size="11" dominant-baseline="middle">
          <text x="{{ sub $left 8 }}" y="{{ add $top (add $step          (div $cell 2)) }}">Mon</text>
          <text x="{{ sub $left 8 }}" y="{{ add $top (add (mul 3 $step)  (div $cell 2)) }}">Wed</text>
          <text x="{{ sub $left 8 }}" y="{{ add $top (add (mul 5 $step)  (div $cell 2)) }}">Fri</text>
        </g>

        <!-- Cells -->
        <g class="ws-cells">
          {{ range $w := seq $weeks }}
            {{ $colBase := add $start (mul (mul (sub $w 1) 7) $oneDay) }}
            {{ range $d := seq 7 }}
              {{ $u := add $colBase (mul (sub $d 1) $oneDay) }}
              {{ $dt := time $u }}
              {{ $key := $dt.Format "2006-01-02" }}
              {{ $cnt := $S.Get (printf "d.%s" $key) | default 0 }}

              {{ $lvl := 0 }}
              {{ if ge $cnt 1 }}{{ $lvl = 1 }}{{ end }}
              {{ if ge $cnt 2 }}{{ $lvl = 2 }}{{ end }}
              {{ if ge $cnt 3 }}{{ $lvl = 3 }}{{ end }}
              {{ if ge $cnt 5 }}{{ $lvl = 4 }}{{ end }}

              <rect
                x="{{ add $left (mul (sub $w 1) $step) }}"
                y="{{ add $top (mul (sub $d 1) $step) }}"
                width="{{ sub $cell 2 }}" height="{{ sub $cell 2 }}"
                rx="2" ry="2" class="ws-cell ws-lv{{ $lvl }}">
                <title>{{ $key }} — {{ $cnt }} post{{ if ne $cnt 1 }}s{{ end }}</title>
              </rect>
            {{ end }}
          {{ end }}
        </g>
      </svg>
    </div>

    <!-- Legend -->
    <div class="ws-legend-row">
      <span class="ws-legend-label">Less</span>
      <span class="ws-box ws-lv0"></span>
      <span class="ws-box ws-lv1"></span>
      <span class="ws-box ws-lv2"></span>
      <span class="ws-box ws-lv3"></span>
      <span class="ws-box ws-lv4"></span>
      <span class="ws-legend-label">More</span>
    </div>
  </div>
</section>

{{ end }}

{{ define "sidebar-prefooter" }}{{ end }}
{{ define "sidebar-footer"  }}{{ end }}
