{{ define "main" }}

{{/* 제목/부제목 */}}
{{ $pageTitle := or .Title .Site.Title }}
{{ $subtitle  := or .Params.lead (site.Params.home.subtitle | default "Step into AI & development.") }}

{{/* ───────── 6개월(26주) 윈도우: 이번 주(월요일) 기준 + 자정 정규화 ───────── */}}
{{ $now := now }}
{{ $weeks := 26 }}
{{ $oneDay := 86400 }}
{{ $wdmap := dict "Mon" 0 "Tue" 1 "Wed" 2 "Thu" 3 "Fri" 4 "Sat" 5 "Sun" 6 }}

{{/* 이번 주 월요일(week start) */}}
{{ $shiftNow := index $wdmap (dateFormat "Mon" $now) | default 0 }}
{{ $startOfThisWeek := sub $now.Unix (mul $shiftNow $oneDay) }}

{{/* 히트맵은 "이번 주"를 마지막 열로 두고, 과거로 (26-1)주 */}}
{{ $start := sub $startOfThisWeek (mul (mul (sub $weeks 1) 7) $oneDay) }}

{{/* 자정(UTC) 정규화 → DST/타임존 드리프트 제거 */}}
{{ $start = mul (div $start $oneDay) $oneDay }}

{{/* 블로그 글 */}}
{{ $blog := site.GetPage "section" "blog" }}
{{ $allPosts := cond $blog $blog.RegularPagesRecursive (slice) }}
{{ $allPosts = where $allPosts "Draft" "!=" true }}

{{/* 날짜별 카운트(히트맵): 에포크 '일' 키로 집계 */}}
{{ $S := newScratch }}
{{ range $p := where $allPosts "Date.Unix" ">" $start }}
  {{ $dayKey := div $p.Date.Unix $oneDay }}  {{/* floor(unix/86400) */}}
  {{ $S.Set (printf "d.%d" $dayKey) (add 1 ($S.Get (printf "d.%d" $dayKey) | default 0)) }}
{{ end }}

{{/* 통계 */}}
{{ $totalPosts := len $allPosts }}
{{ $thisMonth := $now.Format "2006-01" }}
{{ $SC := newScratch }}{{ $SC.Set "mcount" 0 }}
{{ range $p := $allPosts }}
  {{ if eq ($p.Date.Format "2006-01") $thisMonth }}
    {{ $SC.Set "mcount" (add ($SC.Get "mcount") 1) }}
  {{ end }}
{{ end }}
{{ $thisMonthCount := $SC.Get "mcount" }}

{{/* 상위 태그 Top3 */}}
{{ $tagCount := dict }}
{{ range $p := $allPosts }}
  {{ with $p.Params.tags }}
    {{ range . }}
      {{ $k := printf "%v" . }}
      {{ $tagCount = merge $tagCount (dict $k (add 1 (index $tagCount $k | default 0))) }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $pairs := slice }}
{{ range $k, $v := $tagCount }}{{ $pairs = $pairs | append (dict "tag" $k "count" $v) }}{{ end }}
{{ $topTags := first 3 (sort $pairs "count" "desc") }}

{{ $since := "" }}
{{ with (first 1 (sort $allPosts "Date" "asc")) }}{{ $since = (index . 0).Date.Format "Jul 2, 2006" }}{{ end }}

{{/* grid sizes */}}
{{ $cell := 14 }} {{ $gap := 4 }} {{ $step := add $cell $gap }}
{{ $left := 64 }} {{ $top := 24 }}
{{ $svgW := add $left (mul $weeks $step) }}
{{ $svgH := add $top (mul 7 $step) }}

<section class="section container py-4">
  <div id="ws-sprinkle" aria-hidden="true"
       data-seedling="{{ "images/seedling.png" | absURL }}"></div>

  <div class="ws-center">
    <h1 class="display-4 fw-bold text-center m-0">{{ $pageTitle }}</h1>
    {{ with $subtitle }}<p class="lead text-muted text-center mt-2 mb-0 ws-subtitle">{{ . }}</p>{{ end }}

    <div class="ws-stats ws-stats--top">
      <div class="ws-metric">
        <div class="ws-metric__label">Total posts</div>
        <div class="ws-metric__value">{{ $totalPosts }} <span class="ws-unit">posts</span></div>
        <div class="ws-metric__sub">since {{ if $since }}{{ $since }}{{ else }}—{{ end }}</div>
      </div>
      <div class="ws-metric">
        <div class="ws-metric__label">This month</div>
        <div class="ws-metric__value">{{ $thisMonthCount }} <span class="ws-unit">posts</span></div>
        <div class="ws-metric__sub">{{ $now.Format "Jan 2006" }}</div>
      </div>
      <div class="ws-metric">
        <div class="ws-metric__label">Top tags</div>
        <div class="ws-metric__value ws-tags-big">
          {{ if gt (len $topTags) 0 }}
            {{ range $i, $it := $topTags }}
              {{ if gt $i 0 }}<span class="ws-tag-sep">·</span>{{ end }}
              <span class="ws-tag">#{{ $it.tag }}</span>
            {{ end }}
          {{ else }}<span class="ws-tag">—</span>{{ end }}
        </div>
        <div class="ws-metric__sub">across all posts</div>
      </div>
    </div>

    <div class="ws-lawn-wrap" style="--ws-left: {{ $left }}px;">
      <svg class="ws-lawn" width="{{ $svgW }}" height="{{ $svgH }}" role="img">
        <g class="ws-months" font-size="11">
          {{ $lastM := "" }}
          {{ range $w := seq $weeks }}
            {{ $colU := add $start (mul (mul (sub $w 1) 7) $oneDay) }}
            {{ $dt := time $colU }}
            {{ $m := dateFormat "Jan" $dt }}
            {{ $d := int (dateFormat "2" $dt) }}
            {{ if and (ne $m $lastM) (le $d 7) }}
              <text x="{{ add $left (mul (sub $w 1) $step) }}" y="12" class="ws-month">{{ $m }}</text>
              {{ $lastM = $m }}
            {{ end }}
          {{ end }}
        </g>

        <g class="ws-weekdays" text-anchor="end" font-size="11" dominant-baseline="middle">
          <text x="{{ sub $left 8 }}" y="{{ add $top (add $step (div $cell 2)) }}">Mon</text>
          <text x="{{ sub $left 8 }}" y="{{ add $top (add (mul 3 $step) (div $cell 2)) }}">Wed</text>
          <text x="{{ sub $left 8 }}" y="{{ add $top (add (mul 5 $step) (div $cell 2)) }}">Fri</text>
        </g>

        <g class="ws-cells">
          {{ range $w := seq $weeks }}
            {{ $colBase := add $start (mul (mul (sub $w 1) 7) $oneDay) }}
            {{ range $d := seq 7 }}
              {{ $u := add $colBase (mul (sub $d 1) $oneDay) }}
              {{ $dt := time $u }}

              {{/* 셀 조회도 에포크 '일' 키로 */}}
              {{ $uday := div $u $oneDay }}
              {{ $cnt := $S.Get (printf "d.%d" $uday) | default 0 }}
              {{ $key := $dt.Format "2006-01-02" }}  {{/* tooltip */}}

              {{/* ── 3단계 팔레트: 0 / 1 / 2+  ── */}}
              {{ $lvl := 0 }}
              {{ if ge $cnt 1 }}{{ $lvl = 3 }}{{ end }}  {{/* 1개 → lv3(중간색) */}}
              {{ if ge $cnt 2 }}{{ $lvl = 4 }}{{ end }}  {{/* 2개+ → lv4(진한색) */}}

              <rect x="{{ add $left (mul (sub $w 1) $step) }}"
                    y="{{ add $top (mul (sub $d 1) $step) }}"
                    width="{{ sub $cell 2 }}" height="{{ sub $cell 2 }}"
                    rx="2" ry="2" class="ws-cell ws-lv{{ $lvl }}">
                <title>{{ $key }} — {{ $cnt }} post{{ if ne $cnt 1 }}s{{ end }}</title>
              </rect>
            {{ end }}
          {{ end }}
        </g>
      </svg>
    </div>

    <div class="ws-legend-row">
      <span class="ws-legend-label">Less</span>
      <span class="ws-box ws-lv0"></span>
      <span class="ws-box ws-lv3"></span>
      <span class="ws-box ws-lv4"></span>
      <span class="ws-legend-label">More</span>
    </div>
  </div>
</section>

{{ end }}

{{ define "sidebar-prefooter" }}{{ end }}

{{ define "sidebar-footer" }}
  {{ $sprinkle := resources.Get "js/ws-sprinkle.js" | js.Build | resources.Fingerprint }}
  <script defer src="{{ $sprinkle.RelPermalink }}"></script>
{{ end }}
